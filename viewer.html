<!DOCTYPE html>
<html>
<head>
    <title>Heatmap for BoZ</title>
    <link rel="stylesheet" href="css/common.css" type="text/css" />
		<style type="text/css">
			.divcss5_list_title{background:#eeeeee; border:1px solid #cccccc; padding:1em;}
			.divcss5_list_content{padding:1em;}
			#tinybox{position:absolute; display:none; padding:10px; background:#ffffff url(image/preload.gif) no-repeat 80% 50%; border:10px solid #e3e3e3; z-index:2000;}
			#tinymask{position:absolute; display:none; top:0; left:0; height:100%; width:100%; background:#000000; z-index:1500;}
			#tinycontent{background:#ffffff; font-size:1.1em;}
			#n{margin:10px auto; width:920px; border:1px solid #CCC;font-size:12px; line-height:30px;}
			#n a{ padding:0 4px; color:#333}
		</style>
		<script type="text/javascript" src="js/tinybox.js"></script>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.14.1/css/ol.css" type="text/css">
	<script src="http://openlayers.org/en/v3.14.1/build/ol.js"></script>
    <script  src = "https://d3js.org/d3.v4.js"> </script >
</head>
<body onload="dataload()">
    <style type="text/css">
        html
        {
            width:100%;
            height:100%;
            margin:0px;
            overflow:hidden;
        }
        body
        {
            width:100%;
            height:100%;
            margin:0px;
            overflow-x:hidden;
            overflow-y:scroll;
        }
        #leftpane
        {
            float:left;
            width:200px;
            height:100%;
            background-color:#EEEEEE;
            overflow:hidden;
        }
        #leftpane p
        {
            margin-left:20px;
            margin-top :20px;
        }

        #leftpane li
        {
            width:40px;
            background:#ccc;
            margin-right:1px;
            list-style-type:none;
            font-size:10pt;
            text-align:center;
            float: left;
        }

        .clearfloat
        {
            clear:left;
        }
        #map
        {
            height:85%;
        }
        #listcontainer
        {
            height:calc(100% - 320px);
            overflow:scroll;
        }
        #dropdownlist1
        {
            width:160px;
            margin-left:20px;
        }
        #calendar1
        {
            width:150px;
            margin-left:20px;
            margin-top:0px;
        }
        #calendar2
        {
            width:60px;
            margin-left:20px;
        }
        #calendar3
        {
            width:60px;
        }
        #button1
        {
            width:80px;
            height:30px;
            margin-left:10px;
            margin-top :10px;
        }
        #button2
        {
            width:80px;
            height:30px;
        }
        #customcontrol{
            position:absolute;
            top: 10px;
            left: 50px;
            width: 100%;
            background-color: transparent;
        }
        #customcontrol .custombutton{
            font-size: 16px;
            width: 100px;
            padding: 5px;
            float: left;
        }
        #customcontrol .custombuttons{
            font-size: 16px;
            width: 30px;
            padding: 5px;
            float: left;
        }
        #customcontrol .custombuttont{
            font-size: 16px;
            width: 20px;
            padding: 5px;
            float: left;
            background-color: transparent;
        }
        #mapselectbox {
            display:none;
            position:absolute;
            top:50px;
            left:1em;
            padding:3px;
            border-radius:4px;
            color:#fff;
            background:rgba(0, 60, 136, 0.5);
            z-index:100;
        }
        #floorselectbox {
            display:none;
            position:absolute;
            top:50px;
            left:10em;
            padding:3px;
            border-radius:4px;
            color:#fff;
            background:rgba(0, 60, 136, 0.5);
            z-index:100;
        }
        #jumpselectbox {
            display:none;
            position:absolute;
            top:50px;
            left:16em;
            padding:3px;
            border-radius:4px;
            color:#fff;
            background:rgba(0, 60, 136, 0.5);
            z-index:100;
        }
        #ScrollAndJump{
            display:none;
            position:absolute;
            float: left;
            top:50px;
            left:24em;
            padding:3px;
            border-radius:4px;
            color:#fff;
            background:rgba(0, 60, 136, 0.5);
            z-index:100;
        }
        #lonrat{
            position:absolute;
            right:2em;
            bottom:2em;
            color:#fff;
            background-color:rgba(0, 60, 136, 0.5);
        }
        #idlonrattm{
            position:absolute;
            left:13em;
            bottom:3.5em;
            color:#fff;
            background-color:rgba(0, 60, 136, 0.5);
        }
        .Lead{
            float:left;
            width:99.5%;
            border-width:4;
            border-style:solid;
            border-color:#66f;
            margin:0px 0px 3px 0px;
            line-height: 110%;
            padding:0;
        }
        .js-slider{
            position:relative;
            left:1em;
            width:70%;
            height:20px;
        }
        .js-slider div{
            background:#ddd;
            height:3px;
            border:1px inset #aaa;
            position:relative;
            top:12px;
            font-size:0px;
        }
        .js-slider input{
            position:absolute;
            width:15px;
            height:20px;
            display:block;
        }
        .table2{
            width: 800px;
            border-collapse: collapse;
        }
        .table2 td{
            padding: 6px;
            background-color: #fff;
            border: 1px solid #b9b9b9;
            text-align: center;
        }
    </style>
    <!--<div id="map" class="map" onclick="MapClicked()"></div>-->
    <div id="map" class="map" ></div>
    <div id="mapselectbox">
        <ul id="mapswitcher" style="list-style-type:none">
            <li><label><input type="radio" name="layer1" value="0" > �n���@�i�W���n�}�j</label></li>
            <li><label><input type="radio" name="layer1" value="1" checked/> OSM</label></li>
        </ul>
    </div>
    <div id="floorselectbox">
        <ul id="floorswitcher" style="list-style-type:none">
            <li><label><input type="radio" name="layer2" value="0"/>����1F</label></li>
            <li><label><input type="radio" name="layer2" value="1"/>����2F</label></li>
            <li><label><input type="radio" name="layer2" value="2"/>����3F</label></li>
            <li><label><input type="radio" name="layer2" value="3"/>����4F</label></li>
            <li><label><input type="radio" name="layer2" value="4" checked/>BoZ</label></li>
        </ul>
    </div>
    <div id="jumpselectbox">
        <button class="custombutton" onclick="MoveToRd()">����</button>
        <button class="custombutton" onclick="MoveToBz()">BoZ</button>
        <button class="custombutton" onclick="MoveToCV()">CEVA</button>
    </div>
    <div id="ScrollAndJump" >
        <button class="custombutton" onclick="ScrollTheScreen()">SCROLL</button>
        <button class="custombutton" onclick="JumpAndDisplayPicture()">JUMP</button>
    </div>
    <div class="ol-unselectable ol-control" id="customcontrol">
        <button class="custombutton" id="mapselector" onclick="ShowMapSelector()">MAP&nbsp;&raquo;</button>
        <button class="custombutton" id="floorselector" onclick="ShowFloorSelector()">FLOOR&nbsp;&raquo;</button>
        <button class="custombutton" id="jumpselector" onclick="ShowJumpSelector()">JUMP&nbsp;&raquo;</button>
        <button class="custombutton" id="ScrollAndJumpSelector" onclick="ShowScrollAndJump()">SCROLL</button>
    </div>
    <form >
        <div class="Lead">
            <label  style="position: relative; float:left; margin-right: 0.1em; width:180px;" id="slider1o">Time:</label>
            <div id="slider1" class="js-slider"  style="float:left;">
                <div></div>
                <input type="button" value=""/>
            </div>
            <div style="clear: both;"></div>
            <input type="checkbox" id="chk_auto" value="Auto"  onClick="checkbox_auto()">Auto</input>
        </div>
        
        <div class="Lead">
            <input style="visibility: hidden" type="file" id="files" name="files[]" />
            <div id="list"></div>
            <label>Start Time:</label>
            <input id="start_Hours" type="text" name="start_Hours" style="width:2%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')" maxlength=2/>
            <label>:</label>
            <input id="start_Min" type="text" name="start_Min" style="width:2%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')" maxlength=2/>
            <label>:</label>
            <input id="start_Sec" type="text" name="start_Sec" style="width:2%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')" maxlength=2/>
            <label> End Time:</label>
            <input id="end_Hours" type="text" name="end_Hours" style="width:2%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')" maxlength=2/>
            <label>:</label>
            <input id="end_Min" type="text" name="end_Min" style="width:2%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')" maxlength=2/>
            <label>:</label>
            <input id="end_Sec" type="text" name="end_Sec" style="width:2%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')" maxlength=2/>
            <label>Time interval(sec):</label>
            <input id="time_interval" type="text" name="time_interval" style="width:5%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')"/>
            <label>Time period(sec):</label>
            <input id="time_period" type="text" name="time_period" style="width:5%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')"/>
            <input id="button_times" type="button" name="button_times" onClick="button_time_set()" value="set" />
        </div>

        <div class="Lead">
            <label  style="position: relative; float:left; margin-right: 0.1em; width:150px;" id="radius_size">radius size :</label>
            <input id="radius" type="range" min="1" max="50" step="1" value="5"/>
        </div>
        
        <div class="Lead">
            <select id="type_poly">
                <option name="None" value="None">None</option>
                <option name="Polygon1" value="Polygon1">Polygon1(Red)</option>
                <option name="Polygon2" value="Polygon2">Polygon2(Green)</option>
            </select>
            <div></div>
            <label>Time period(sec):</label>
            <input id="time_period_poly" type="text" name="time_period_poly" style="width:5%;padding:0px;font-size:15px;" onKeyup="this.value=this.value.replace(/[^0-9]+/i,'')"/>
            <input id="button_polyc" type="button" name="button_polyc" onClick="button_poly_calc()" value="calc" />
            <input id="button_polyd" type="button" name="button_polyd" onClick="button_poly_del()" value="delete" />
            <div></div>
            <label  id="msg_poly_lot"></label>
            <label  id="msg_poly_area"></label>
            <table id="table_poly" class="table2" border=1></table>
        </div>

        <div class="Lead">
            <label>Marker (Longitude, Latitude, Orientation)</label>
            <input id="mak_up" type="text" name="mak_up" size="15" onKeyup="this.value=this.value.replace(/[^0-9\.]+/i,'')"/>
            <input id="mak_lo" type="text" name="mak_lo" size="15" onKeyup="this.value=this.value.replace(/[^0-9\.]+/i,'')"/>
            <input id="mak_or" type="text" name="mak_or" size="15" onKeyup="this.value=this.value.replace(/[^0-9\.]+/i,'')"/>
            <input id="button_makset" type="button" name="button_makset" onClick="button_mak_set()"  value="set" />
            <input id="button_makdel" type="button" name="button_makdel" onClick="button_mak_del()" value="delete" />
        </div>

        <div class="Lead">
            <label>Angle of view: (Upper, Lower)</label>
            <input id="ang_up" type="text" name="ang_up" placeholder="18" size="10" onKeyup="this.value=this.value.replace(/[^0-9\.]+/i,'')"/>
            <input id="ang_lo" type="text" name="ang_lo" placeholder="22" size="10" onKeyup="this.value=this.value.replace(/[^0-9\.]+/i,'')"/>
            <label>Distance(m) : (Near, Far)</label>
            <input id="de_ri" type="text" name="de_ri" placeholder="2" size="10" onKeyup="this.value=this.value.replace(/[^0-9\.]+/i,'')"/>
            <input id="de_le" type="text" name="de_le" placeholder="35" size="10" onKeyup="this.value=this.value.replace(/[^0-9\.]+/i,'')"/>
            <input id="button_lines" type="button" name="button_lines" onClick="button_line_set()"  value="set" />
            <input id="button_lined" type="button" name="button_lined" onClick="button_line_del()" value="delete" />
        </div>
        
        <div id="set_time_dff" class="Lead">
            <label>Time difference(h) : </label>
            <input id="tm_df" type="text" name="tm_df" placeholder="-8" size="10" onKeyup="this.value=this.value.replace(/[^0-9\.\-]+/i,'')"/>
            <input id="button_timediffs" type="button" name="button_timediffs" onClick="button_timediff_set()"  value="set" />
        </div>

        <div id="msg" class="Lead"></div>
        <div id="msg_fileno" class="Lead"></div>

    </form>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script>
        //var locstring = String(window.document.location.href);
        //var fullurl = document.getElementById('fullurl');
        //fullurl.innerHTML=locstring    
        //var divpass = document.getElementById('passpara');
        //divpass.innerHTML="the file selected is "+ GetQueryString(locstring,'name');

        //function GetQueryString(str,id) {
        //    var URLParams = new Array();  
        //    var params = document.location.search.substr(1).split('&');   
        //    for (i=0; i < params.length ; i++){  
        //        var aParam = params[i].split('=');   
        //        URLParams[aParam[0]] = aParam[1];   
        //    }  
        //    return URLParams[id];
        //}
    </script>
    <script>
        var locstring = String(window.document.location.href);
        var directoryname = GetQueryString(locstring,'name');
        var imageDirectory= "/data/"+directoryname +"/Recognition/";

        function GetQueryString(str,id) {
            var URLParams = new Array();  
            var params = document.location.search.substr(1).split('&');   
            for (i=0; i < params.length ; i++){  
                var aParam = params[i].split('=');   
                URLParams[aParam[0]] = aParam[1];   
            }  
            return URLParams[id];
        }
        
        var map;										//�}�b�v�I�u�W�F�N�g
        var maplayer=[];                                //�}�b�v���C���[
        var floorlayer=[];								//�t���A���C���[
        var snapsource=null;
        var positionlayer=new Object();					//���ʃf�[�^���C���[�iKML�x�N�g���A�q�[�g�}�b�v�j
        var heatnum = 0;

        var heattime = 2000;
        var timer_1;

        var radius = document.getElementById('radius');
        var markerA;
        var Lon_maker;
        var Lat_maker;
        var Ang_maker;
        var onMaker = 0;
        var lineVector_l;
        var Lon_m; // hubeny
        var Lat_m;
        var map_ang = 180;

        var str3_input_up = 18;
        var str3_input_lo = 22;
        var str3_input_dele = 35;
        var str3_input_deri = 2;      
// for csv
        var tm=[];
        var frameNo=[];
        var pointFeatures=[];
        var isFeatures=[];
        var time_intvl_length = 0;
        var all_time = 0;
        var file_length = 0;
        var startTime;
        var endTime;
        var intervalTime;
        var periodTime;
        var samplingTime = 0;
        var time_diff = -8;

        var file_output = [];
        
        var DisplayImageList = [];
        var currentImageIndex = 0;
        var ImageIndex=0;
        var redLineCount = 0;

// time slider
		var slider = document.getElementById('slider1');

		var input = slider.getElementsByTagName('input')[0];
		var dragging = false;
		var value_0 = 0;// ����ʒu
		var width = input.clientWidth / 2;

		var set_value = function (){
			var length = time_intvl_length;
			var rect = slider.getBoundingClientRect();
			var value_max =  Math.round(rect.right - rect.left);
			var value_step, value_file, value_slide;

			if(length > 1){
				value_step = value_max / (length - 1);
				value_file = Math.round(value_0 / value_step);
				value_slide = Math.round(value_file * value_step);
			}else{
				value_file = 0;
				value_slide = 0;
				value_0 = 0;
			}

			if(length > 0){
				dynamicHeatLayer1(value_file);
			}

			// �܂݂̃T�C�Y(input.clientWidth)�����ʒu�𒲐�
			input.style.left = (value_slide - input.clientWidth/2) + 'px';
		};       

        set_value();    

		// �ڐ��蕔�����N���b�N�����Ƃ�
		slider.onclick = function(evt){
			dragging = true;
			document.onmousemove(evt);
			document.onmouseup();
		};
		// �h���b�O�J�n
		input.onmousedown = function(evt){
			dragging = true;
			return false;
		};
		// �h���b�O�I��
		document.onmouseup = function(evt){
			if (dragging) {
				dragging = false;
			}
		};
		document.onmousemove = function(evt){
			if(dragging){
				// �h���b�O�r��
				if(!evt){
					evt = window.event;
				}
				var left = evt.clientX;
				var rect = slider.getBoundingClientRect();
				// �}�E�X���W�ƃX���C�_�[�̈ʒu�֌W�Œl�����߂�
				value_0 = Math.round(left - rect.left - width);

				// �X���C�_�[����͂ݏo�����Ƃ�
				if (value_0 < 0) {
					value_0 = 0;
				} else if (value_0 > slider.clientWidth) {
					value_0 = slider.clientWidth;
				}
				set_value();
				return false;
			}
		};      

// �x�[�X�̒n�}�쐬�i�n���@�n�}�j
        var mapsourceattribution=new ol.Attribution({
          html: "<a href='http://portal.cyberjapan.jp/help/termsofuse.html' target='_blank'>���y�n���@</a>"
        })

        maplayer[0]=new ol.layer.Tile({
            source: new ol.source.XYZ({
                attributions: [mapsourceattribution],
                url: "http://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
                projection: "EPSG:3857"
            })
        })
        maplayer[0].setVisible(false);
        document.getElementsByName("layer1")[1].checked = true;
        maplayer[1]=new ol.layer.Tile({
            source: new ol.source.OSM()
        })
        maplayer[1].setVisible(true);     

        map = new ol.Map({
        target: "map",
            renderer: "canvas",
            layers: [maplayer[0],maplayer[1]],
            view: view=new ol.View({
                center: ol.proj.transform([-0.6940961638553076, 52.50398587968243], 'EPSG:4326', 'EPSG:3857'),
                zoom: 18,
                rotation: 5.156592987079622
          })
        });  

        map.addControl(new ol.control.ScaleLine());
        map.addControl(new ol.control.ZoomSlider());

            // �t���A�}�b�v�쐬
        floorlayer[0]=new ol.layer.Tile({
            opacity: 0.95,
            source: new ol.source.XYZ({
                url: "http://165.96.242.70/map/rd1/{z}/{x}/{y}.png",
                projection: "EPSG:3857"
            })
        })
        map.addLayer(floorlayer[0]);
        floorlayer[0].setVisible(false);
        floorlayer[1]=new ol.layer.Tile({
            opacity: 0.95,
            source: new ol.source.XYZ({
                url: "http://165.96.242.70/map/rd2/{z}/{x}/{y}.png",
                projection: "EPSG:3857"
            })
        })
        map.addLayer(floorlayer[1]);
        floorlayer[1].setVisible(false);
        floorlayer[2]=new ol.layer.Tile({
            opacity: 0.95,
            source: new ol.source.XYZ({
                url: "http://165.96.242.70/map/rd3/{z}/{x}/{y}.png",
                projection: "EPSG:3857"
            })
        })
        map.addLayer(floorlayer[2]);
        floorlayer[2].setVisible(false);
        floorlayer[3]=new ol.layer.Tile({
            opacity: 0.95,
            source: new ol.source.XYZ({
                url: "http://165.96.242.70/map/rd4/{z}/{x}/{y}.png",
                projection: "EPSG:3857"
            })
        })
        map.addLayer(floorlayer[3]);
        floorlayer[3].setVisible(false);
        document.getElementsByName("layer2")[4].checked = true;
        floorlayer[4]=new ol.layer.Tile({
            opacity: 0.95,
            source: new ol.source.XYZ({
                url: "http://10.62.23.151/map/{z}/{x}/{y}.png",
                projection: "EPSG:3857"
            })
        })
        map.addLayer(floorlayer[4]);
        floorlayer[4].setVisible(true);    

// �q�[�g�}�b�v�쐬
        var dyndata = new ol.source.Vector();

        var dynHeatMapLayer = new ol.layer.Heatmap({
            source: dyndata,
            blur: parseInt(radius.value, 10)*2,
            radius: parseInt(radius.value, 10)
        });
        map.addLayer(dynHeatMapLayer);

        function getData(name) {
            var dataurl = "/data/"+directoryname+"/"+name+".csv";
            var xmlhttp;
            try{
                xmlhttp=new ActiveXObject("Msxml2.XMLHTTP");
            }catch(e){
                try{
                    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
                }catch(e){	}
            }
            if(!xmlhttp) {
                xmlhttp=new XMLHttpRequest();
            }else {
                return "";
            }
            var responseText =""
            xmlhttp.onreadystatechange = function () {
                if(xmlhttp.readyState == 4){
                    responseText = xmlhttp.responseText;
                    responseText=responseText.replace(/</g,"&lt;");
                    responseText=responseText.replace(/>/g,"&gt;");
                    if(name == "timestamp"){
                        updateTimestampData(responseText)
                    }else if(name == "heatmap"){
                        updateHeatmapData(responseText)
                    }
                    xmlhttp = null;
                }
            }
            xmlhttp.open("GET",dataurl,true);
            xmlhttp.send(null);
            return responseText;
        }

        function isNull(str){
            if ( str.length == 0 )
                return true;
            var regu = "^[ ]+$";
            var re = new RegExp(regu);
            return re.test(str);
        }

        function updateTimestampData(content) {
            DisplayImageList.splice(0,DisplayImageList.length);
            var l=content.split('\n');
            for(var i = 0;i<l.length;i++){
                var strItem = l[i].replace('\r','');
                if(!isNull(strItem)){
                    var d=l[i].split(',');
                    var coordinates = [];
                    var isred = false;
                    var imageitemobj = displayimageitem(d[0],isred,new Date(d[1],d[2],d[3],d[4],d[5],d[6],d[7]),coordinates);
                    DisplayImageList.push(imageitemobj);
                }
            }
        }
        
        function updateHeatmapData(content) {
            document.getElementById("button_times").disabled = true;
            document.getElementById("files").disabled = true;
            document.getElementById("type_poly").disabled = true;
            document.getElementById("button_polyc").disabled = true;
            document.getElementById("button_polyd").disabled = true;
            document.getElementById("button_timediffs").disabled = true;

            var i;
            var j = 0;
            tm = [];
            pointFeatures = [];
            isFeatures = [];
            frameNo = [];

            if(content != ""){
                for(i=0;i<=file_length;i++){
                    if(isFeatures[i]){
                        dyndata.removeFeature(pointFeatures[i]);
                        isFeatures[i]=false;
                    }
                }
            }else {
                document.getElementById("button_times").disabled = false;
                document.getElementById("files").disabled = false;
                document.getElementById("type_poly").disabled = false;
                document.getElementById("button_polyc").disabled = false;
                document.getElementById("button_polyd").disabled = false;
                document.getElementById("button_timediffs").disabled = false;
                document.getElementById("list").innerHTML =  'Bad data source';
                time_intvl_length = 0;
                return;
            }

            var l=content.split('\n');
            for(i=0;i<l.length;i++){
                if(!isNull(l[i])){				//��s�X�L�b�v
                    var d=l[i].split(',');
                    if(d[0] == '#'){ //�R�����g�s
                        if(d[1] == '1'){ //�A�J�����ʒu�̐ݒ�
                            Lon_maker = d[2];
                            document.getElementById('mak_up').value = d[2];
                            Lat_maker = d[3];
                            document.getElementById('mak_lo').value = d[3];
                            Ang_maker = d[4];
                            document.getElementById('mak_or').value = d[4];
                        }
                        if(d[1] == '6'){ //�A�T���v�����O
                            samplingTime = parseFloat(d[2]);
                        }
                    }else{
                        var lon2=parseFloat(d[0]);
                        var lat2=parseFloat(d[1]);
                        tm[j]=new Date(d[2].substring(0,19));
                        addCoor(d[3],lon2,lat2);
                        // ��������
                        time_diff = parseFloat(document.getElementById('tm_df').value, 10);
                        if(isNaN(time_diff) )   time_diff = -8 ;
                        if(time_diff != 0) tm[j].setHours(tm[j].getHours() + time_diff);
                        coord =ol.proj.transform([lon2, lat2], 'EPSG:4326', 'EPSG:3857');
                        lonLat= new ol.geom.Point(coord);
                        pointFeature=new ol.Feature({
                            geometry: lonLat,
                            weight: 0.2 // e.g. temperature
                        });
                        pointFeatures[j] = pointFeature;
                        isFeatures[j] = false;
                        frameNo[j] =parseInt(d[3]);
                        j = j + 1;
                    }
                }
            }
            file_length = j - 1;
            startTime = new Date(tm[0]);
            startTime.setSeconds(0);
            endTime   = new Date(tm[file_length]);
            if(d[2].substring(20,23) != 0){
                endTime.setSeconds(endTime.getSeconds() + 1);
            }

            get_timeparm_intper();
            set_value();

            file_set_timeparm();
            list_set_timeparm();

            button_mak_set();
            button_line_set();

            // Polygon
            if(document.getElementById('time_period_poly').value == ""){
                document.getElementById('time_period_poly').value = 60;
            }
            document.getElementById("msg_poly_lot").innerHTML =  '' ;
            document.getElementById("msg_poly_area").innerHTML =  '' ;
            var table = document.getElementById("table_poly");
            while( table.rows[ 0 ] ) table.deleteRow( 0 ); //�폜

            document.getElementById("button_times").disabled = false;
            document.getElementById("files").disabled = false;
            document.getElementById("type_poly").disabled = false;
            document.getElementById("button_polyc").disabled = false;
            document.getElementById("button_polyd").disabled = false;
            document.getElementById("button_timediffs").disabled = false;
        }

        function addCoor(frameNo,longitude,latitude){
            var frameIndex = parseInt(frameNo);
            if(DisplayImageList[frameIndex].filename.trim() == frameNo.trim()){
                if(DisplayImageList[frameIndex].coordinates == null){
                    DisplayImageList[frameIndex].coordinates = [];
                }
                var coor = new datacoordinate(longitude,latitude);
                DisplayImageList[frameIndex].coordinates.push(coor);

            }
        }
        
        function dataload() {
            getData("timestamp");
            getData("heatmap");
        }
        
        function displayimageitem(name,isred,time,coordinates){
            var imgitem = new Object;
            imgitem.filename = name;
            imgitem.isRed = isred;
            imgitem.time = time;
            imgitem.coordinates = coordinates;
            return imgitem;
        }

        function datacoordinate(longitude,latitude) {
            var coor = new Object;
            coor.longitude = longitude;
            coor.latitude = latitude;
            return coor;
        }

        var playIntervalid;

        map.addEventListener("click",function(e){
            var x = parseFloat(e.map.U[0]);
            var y = parseFloat(e.map.U[1]);
            //var TargetCoor = ol.proj.transform(e.map.U,"EPSG:900913", "EPSG:4326");
            var htmlStr = trimSpaces(T$('ScrollAndJumpSelector').innerHTML);
            var para = DisplayImageList.length;
            if((htmlStr == "JUMP")){
                if(para >= 0){
                    currentImageIndex = 0;
                    clearInterval(playIntervalid);
                    var radiusvalue = parseFloat(radius.value) ;
                    redLineCount = 0;
                    for(var rednum =0;rednum<DisplayImageList.length;rednum++){
                        DisplayImageList[rednum].isRed = false;
                        if(DisplayImageList[rednum].coordinates.length>0){
                            for(var coordinateindex = 0;coordinateindex<DisplayImageList[rednum].coordinates.length;coordinateindex++){
                                var currentcoordinate = DisplayImageList[rednum].coordinates[coordinateindex];
                                var coord = convertCoordinate(currentcoordinate["longitude"],currentcoordinate["latitude"]);
                                var distance = DistanceOfPoints(x,coord[0],y,coord[1]);
                                if(distance < radiusvalue){
                                    DisplayImageList[rednum].isRed = true;
                                    redLineCount++;
                                    break;
                                }
                            }
                        }
                    }

                    clearInterval(imgLoadCheckTimer);
                    var content2 = "<div><div align='center' height='520'><img id='popupImg' width='640' height='480' SlideAndFadeOutSlideAndFadeOutSlideAndFadeOut src='"+imageDirectory+ConvertImageIndexToFrame(DisplayImageList[currentImageIndex].filename)+".png' onerror='errorinput(this);' /></div><div id='redlineslider' class='sliderDiV'></div><div><table><tr><td width='75'><input type='image' id='last1'  width = '49' src='image/Last1.png' onclick='playforward()'/></td><td width='75'><img id='last2' width = '49' src='image/Last2.png' onclick='lastredline()'/></td><td width='75'><img id='popupLastImg' width = '49' src='image/Last3.png' onclick='lastimage()'/></td><td width='75'><h4 id='imageTime'>"+getdisplaytime(DisplayImageList[currentImageIndex])+"</h4></td><td width='75'><img id='popupNextImg' width = '49' src='image/Next3.png' onclick='nextimage()'/></td><td width='75'><img id='next2' width = '49' src='image/Next2.png' onclick='nextredline()'/></td><td width='75'><input type='image' id='next1' width = '49' src='image/Next1.png'  onclick='playback()'/></td><td width='75'><button id='CloseButton' width = '50' onclick='closepopupimage()'>Close</button></td></tr></table></div></div>";
                    TINY.box.show(content2,0,0,0,1);
                    imgLoadCheck();
                }else{
                    alert("No para");
                }
            }
        ;});

        function DistanceOfPoints(x1,x2,y1,y2) {
            return Math.sqrt(Math.pow((parseFloat(x1)-parseFloat(x2)),2)+Math.pow((parseFloat(y1)-parseFloat(y2)),2))
        }

        function CleanAllTimeInterval() {
            clearInterval(imgLoadCheckTimer);
            clearInterval(playIntervalid);
            playIntervalid = null;
            imgLoadCheckTimer = null;
        }
        
        var imgLoadCheckTimer;

        function imgLoadCheck() {
            imgLoadCheckTimer = setInterval(function() {
                var popupImageItem = T$('redlineslider');
                if(popupImageItem != null){
                    //console.log("Image Get");
                    if (popupImageItem.offsetWidth >0) {
                        clearInterval(imgLoadCheckTimer);
                        showRedLine();
                    }
                }
            }, 500)
        }
        function showRedLine(){
            if(DisplayImageList.length > 0){
                var sliderSupportDiv = T$('slidersupport');
                if(sliderSupportDiv){
                    sliderSupportDiv.parentNode.removeChild(sliderSupportDiv);
                }
                sliderSupportDiv = document.createElement('div');
                sliderSupportDiv.className = 'supportDiv';
                sliderSupportDiv.id = 'slidersupport';
                var sliderdiv = T$('redlineslider');
                sliderdiv.appendChild(sliderSupportDiv);

                var lineWidth = parseInt((sliderdiv.offsetWidth)/DisplayImageList.length);
                if(lineWidth < 1){
                    lineWidth = 1;
                }	
                console.log("line width is "+lineWidth);
                console.log("Red line number is " + redLineCount);
                var lastlocation = 0;
                for(var lineindex = 0;lineindex<DisplayImageList.length;lineindex++){
                    if(DisplayImageList[lineindex].isRed == true){
                        var p=document.createElement('div');
                        p.id='linediv_'+lineindex;
                        sliderSupportDiv.appendChild(p);
                        var currentlocation = parseInt(((lineindex/DisplayImageList.length)*sliderdiv.offsetWidth));
                        p.style.marginLeft = (currentlocation - lastlocation)+"px";
                        lastlocation = currentlocation + lineWidth;
                        p.style.width = lineWidth+"px";
                        p.style.height = sliderdiv.offsetHeight;
                        p.style.background = "#FF0000";
                        p.style.float = "left";
                    }
                }					
            }
        }

        function ConvertImageIndexToFrame(imageIndex){
            var index = parseInt(imageIndex);
            if(index<0){
                return "";
            }
            if(index < 10){
                return "00000"+index;
            }else if(index < 100){
                return "0000"+index;
            }else if(index < 1000){
                return "000"+index;
            }else if(index < 10000){
                return "00"+index;
            }else{
                return "0"+index;
            }
        }

        function playback(){
            if(playIntervalid){
                console.log("PlayBack out");
                return;
            }
            var imageTime = document.getElementById('imageTime');
            var last1Btn = document.getElementById('last1');
            if(DisplayImageList.length > 0){
                if(currentImageIndex < DisplayImageList.length-1 ){
                    playIntervalid = setInterval(function(){
                        if(currentImageIndex <= DisplayImageList.length-1 ){
                            imageTime.innerText = getdisplaytime(DisplayImageList[currentImageIndex]);
                            displayimageonpopupimg(currentImageIndex);
                            currentImageIndex++;
                            last1Btn.disabled = true;
                        }else{
                            currentImageIndex = DisplayImageList.length-1;
                            clearInterval(playIntervalid);
                            last1Btn.disabled = false;
                        }
                    },300);
                }
            }
        }

        function playforward(){
            var next1btn = document.getElementById('next1');
            var imageTime = document.getElementById('imageTime');
            if(playIntervalid)
                return;
            if(DisplayImageList.length > 0){
                if(currentImageIndex > 0){
                    playIntervalid = setInterval(function(){
                        if(currentImageIndex >= 0 ){
                            imageTime.innerText = getdisplaytime(DisplayImageList[currentImageIndex]);
                            displayimageonpopupimg(currentImageIndex);
                            currentImageIndex--;
                            next1btn.disabled = true;
                        }else{
                            currentImageIndex = 0;
                            clearInterval(playIntervalid);
                            next1btn.disabled = false;
                        }
                    },300);  						
                }
            }
        }

        function lastredline(){
            var imageTime = document.getElementById('imageTime');
            if(DisplayImageList.length > 0){
                if(currentImageIndex >0){
                    if(DisplayImageList[currentImageIndex].isRed == true){
                        currentImageIndex--;
                    }
                    for(var currentIndex = currentImageIndex;currentIndex>=0;currentIndex--){
                        //find last redline from DisplayImageList
                        var tmpimgitem = DisplayImageList[currentIndex];
                        if(tmpimgitem.isRed == true){
                            var popupImageItem = T$('popupImg');
                            popupImageItem.src = imageDirectory +ConvertImageIndexToFrame(tmpimgitem.filename)+'.png';
                            imageTime.innerText = getdisplaytime(tmpimgitem);
                            currentImageIndex = currentIndex;
                            break;
                        }
                    }
                }
            }
        }

        function nextredline(){
            var imageTime = document.getElementById('imageTime');
            if(DisplayImageList.length > 0){
                if(currentImageIndex <DisplayImageList.length-1){
                    if(DisplayImageList[currentImageIndex].isRed == true){
                        currentImageIndex++;
                    }
                    for(var currentIndex = currentImageIndex;currentIndex <= DisplayImageList.length-1;currentIndex++){
                        var tmpimgitem = DisplayImageList[currentIndex];
                        if(tmpimgitem.isRed == true){
                            var popupImageItem = T$('popupImg');
                            popupImageItem.src = imageDirectory+ConvertImageIndexToFrame(tmpimgitem.filename)+'.png';
                            imageTime.innerText = getdisplaytime(tmpimgitem);
                            currentImageIndex = currentIndex;
                            break;
                        }
                    }
                }
            }
        }


        function lastimage(){
            var imageTime = document.getElementById('imageTime');
            if(currentImageIndex > 0){
                currentImageIndex--;
            }else{
                currentImageIndex = 0;
            }
            displayimageonpopupimg(currentImageIndex);
            imageTime.innerText = getdisplaytime(DisplayImageList[currentImageIndex]);
        }

        function nextimage(){
            var imageTime = document.getElementById('imageTime');
            if(currentImageIndex < DisplayImageList.length-1){
                currentImageIndex++;
            }else{
                currentImageIndex = DisplayImageList.length-1;
            }
            displayimageonpopupimg(currentImageIndex);
            imageTime.innerText = getdisplaytime(DisplayImageList[currentImageIndex]);
        }
        
        function closepopupimage() {
            TINY.box.hide();
            CleanAllTimeInterval();
            console.log("Popup Closed");
        }


        function getdisplaytime(imageitem){
            var tmpMillSe = parseInt(imageitem.time.getMilliseconds());
            var tmpStr = "000 ";
            if(isNaN(tmpMillSe) == false){
                if(tmpMillSe<10){
                    tmpStr="00"+tmpMillSe+" ";
                }else if(tmpMillSe<100 ){
                    tmpStr = "0" + tmpMillSe +" ";
                }else {
                    tmpStr = tmpMillSe + "";
                }
            }
            var timestring = imageitem.time.getHours()+":"+imageitem.time.getMinutes()+":"+imageitem.time.getSeconds()+".";
            return timestring+tmpStr;
        }

        function displayimageonpopupimg(imgindex){
            var popupImageItem = T$('popupImg');
            var tmpcurrentimgitem = DisplayImageList[imgindex];
            popupImageItem.src = imageDirectory+ConvertImageIndexToFrame(tmpcurrentimgitem.filename)+'.png';
        }

        function dynamicHeatLayer1(timeNumber){
            var i;
            var slid_start_FileNo = -1;
            var slid_end_FileNo;
            var slid_start = new Date(startTime);

            slid_start.setSeconds(slid_start.getSeconds() + timeNumber*intervalTime);

            var slid_end = new Date(slid_start);
            slid_end.setSeconds(slid_end.getSeconds() + periodTime);

            document.getElementById("slider1o").innerHTML =  'Time �F' + date2str(slid_start) + ' - '+ time2str(slid_end) ;

            for(i=0;i<=file_length;i++){
                if((tm[i]<slid_start)&(isFeatures[i])){
                    dyndata.removeFeature(pointFeatures[i]);
                    isFeatures[i]=false;
                }
                if((tm[i]>=slid_end)&(isFeatures[i])){
                    dyndata.removeFeature(pointFeatures[i]);
                    isFeatures[i]=false;
                }
                if((tm[i]>=slid_start)&(tm[i]<slid_end)&(!isFeatures[i])){
                    dyndata.addFeature(pointFeatures[i]);
                    isFeatures[i]=true;
                }
                if((tm[i]>=slid_start) && (slid_start_FileNo == -1)) slid_start_FileNo = frameNo[i];
                if(tm[i]<slid_end) slid_end_FileNo = frameNo[i];
            }

            document.getElementById("msg_fileno").innerHTML =  'nFrameNo:' + slid_start_FileNo + ' - ' + slid_end_FileNo;
        }  

        checkbox_auto();   

        function checkbox_auto() {
            if(document.getElementById("chk_auto").checked){
                var fsize = time_intvl_length; 
                var rect = slider.getBoundingClientRect();
                var value_max =  Math.round(rect.right - rect.left);
                if((fsize > 1) ) heatnum = Math.round(value_0 / (value_max / (fsize - 1)));
                timer_1 = setInterval(ShowAutoHeatMap, heattime);
            }else{
                var fsize = time_intvl_length;
                var rect = slider.getBoundingClientRect();
                var value_max =  Math.round(rect.right - rect.left);
                clearInterval(timer_1);
                if(fsize > 1) value_0 = (value_max / (fsize - 1)) * heatnum;
                set_value();
            }
        }
        
        function ShowAutoHeatMap() {
            var fsize = time_intvl_length; 
            var rect = slider.getBoundingClientRect();
            var value_max =  Math.round(rect.right - rect.left);
            var value_step, value_slide = 0;
            var i;

            if(fsize == 0){
            
            }else if((heatnum + 1) > fsize){
                heatnum = 0;
                heattime = 1000;
                document.getElementById("slider1o").innerHTML =  'Time �F' ;

                for(i=0;i<=file_length;i++){
                    if(isFeatures[i]){
                        dyndata.removeFeature(pointFeatures[i]);
                        isFeatures[i]=false;
                    }
                }
            }else{
                dynamicHeatLayer1(heatnum);
                if((fsize > 1) ){
                    value_step = value_max / (fsize - 1);
                    value_slide = Math.round(heatnum * value_step);
                }
                // �܂݂̃T�C�Y(input.clientWidth)�����ʒu�𒲐�
                input.style.left = (value_slide - input.clientWidth/2) + 'px';
                heatnum += 1;
                heattime = 1000;
            }
        }        
        
        document.getElementById("radius_size").innerHTML = 'radius size :' + radius.value ;

        radius.addEventListener('change', function() {
            document.getElementById("radius_size").innerHTML = 'radius size :' + radius.value ;
            dynHeatMapLayer.setRadius(parseInt(radius.value, 10));
            dynHeatMapLayer.setBlur(parseInt(radius.value, 10)*2);
        });  

        //�}�E�X�ʒu�̈ܓx�o�x�\��
        map.on('pointermove', function(evt) {
            var coordinate = evt.coordinate;
            var stringifyFunc = ol.coordinate.createStringXY(10);
            var str;

            var str2 = ol.proj.transform(map.getView().getCenter(), 'EPSG:3857', 'EPSG:4326');
            var str3 = map.getView().getZoom();
            var str4 = map.getView().getRotation();

            document.getElementById("msg").innerHTML  = str2[0]  + ', '+ str2[1]  + ', ' + str3 + ', '+  str4 ;
        });      

        //�n�}�I��
        function ShowMapSelector(){
            if(jQuery('#mapselectbox').css('display')=='none'){
                jQuery('#mapselectbox').css('display','block');
                $("#mapselector").html("MAP&nbsp;&laquo;");
            }
            else{
                jQuery('#mapselectbox').css('display','none');
                $("#mapselector").html("MAP&nbsp;&raquo;");
            }
        }      

        //�t���A�I��
        function ShowFloorSelector(){
            if(jQuery('#floorselectbox').css('display')=='none'){
                jQuery('#floorselectbox').css('display','block');
                $("#floorselector").html("FLOOR&nbsp;&laquo;");
            }
            else{
                jQuery('#floorselectbox').css('display','none');
                $("#floorselector").html("FLOOR&nbsp;&raquo;");
            }
        }

        //�W�����v�I��
        function ShowJumpSelector(){
            if(jQuery('#jumpselectbox').css('display')=='none'){
                jQuery('#jumpselectbox').css('display','block');
                $("#jumpselector").html("JUMP&nbsp;&laquo;");
            }
            else{
                jQuery('#jumpselectbox').css('display','none');
                $("#jumpselector").html("JUMP&nbsp;&raquo;");
            }
        }

        function ShowScrollAndJump(){
            if(jQuery('#ScrollAndJump').css('display')=='none'){
                jQuery('#ScrollAndJump').css('display','block');
                //$("#ScrollAndJumpSelector").html("JUMP");
            }
            else{
                //jQuery('#ScrollAndJump').css('display','none');
                //$("#ScrollAndJumpSelector").html("Scroll");
            }				
        }

        jQuery("#mapswitcher input[name=layer1]").change(function(){
            var checkedLayer = jQuery('#mapswitcher input[name=layer1]:checked').val();
            for (i = 0, ii = maplayer.length; i < ii; ++i) maplayer[i].setVisible(i==checkedLayer);
        } );

        jQuery("#floorswitcher input[name=layer2]").change(function(){
            var checkedLayer = jQuery('#floorswitcher input[name=layer2]:checked').val();
            for (i = 0, ii = floorlayer.length; i < ii; ++i) floorlayer[i].setVisible(i==checkedLayer);
        } );


        //���ʃf�[�^���C���[�̍폜
        function Removepositionlayer(hashin){
            map.removeLayer(positionlayer[hashin]);
            delete positionlayer[hashin];
        }

			//�W�����v
        function MoveToRd() {
            var radioList1 = document.getElementsByName("layer1");
            var radioList2 = document.getElementsByName("layer2");
            var checkedLayer1 = 0;
            var checkedLayer2 = 1;

            mapMove(139.594205,35.537473,-0.5,18);

            radioList1[checkedLayer1].checked = true;
            for (i = 0, ii = maplayer.length; i < ii; ++i) maplayer[i].setVisible(i==checkedLayer1);

            radioList2[checkedLayer2].checked = true;
            for (i = 0, ii = floorlayer.length; i < ii; ++i) floorlayer[i].setVisible(i==checkedLayer2);
        }
        function MoveToBz(){
            var radioList1 = document.getElementsByName("layer1");
            var radioList2 = document.getElementsByName("layer2");
            var checkedLayer1 = 1;
            var checkedLayer2 = 4;

            mapMove(4.2569479549,51.4961659698,2.16944,17);

            radioList1[checkedLayer1].checked = true;
            for (i = 0, ii = maplayer.length; i < ii; ++i) maplayer[i].setVisible(i==checkedLayer1);

            radioList2[checkedLayer2].checked = true;
            for (i = 0, ii = floorlayer.length; i < ii; ++i) floorlayer[i].setVisible(i==checkedLayer2);

        }
        function MoveToCV(){
            var radioList1 = document.getElementsByName("layer1");
            var radioList2 = document.getElementsByName("layer2");
            var checkedLayer1 = 1;
            var checkedLayer2 = 4;

            mapMove(-0.6940961638553076, 52.50398587968243, 5.156592987079622, 18);

            radioList1[checkedLayer1].checked = true;
            for (i = 0, ii = maplayer.length; i < ii; ++i) maplayer[i].setVisible(i==checkedLayer1);

            radioList2[checkedLayer2].checked = true;
            for (i = 0, ii = floorlayer.length; i < ii; ++i) floorlayer[i].setVisible(i==checkedLayer2);

        }

        //�w��ܓx�o�x�Ɉړ�
        function mapMove(lon, lat, rotation, zoom) {
            //�e�퍀�ڂ̃��Z�b�g
            view.setCenter(ol.proj.transform([lon, lat], "EPSG:4326", "EPSG:3857"));
            var coord = ol.proj.transform([lon, lat], "EPSG:4326", "EPSG:3857");
            view.setRotation(rotation);
            view.setZoom(zoom);
        }

        function ScrollTheScreen(){
            $("#ScrollAndJumpSelector").html("SCROLL");
            jQuery('#ScrollAndJump').css('display','none');
        }

        function JumpAndDisplayPicture(){
            $("#ScrollAndJumpSelector").html("JUMP");
            jQuery('#ScrollAndJump').css('display','none');
        }

//file
        document.getElementById('files').value ="";
        document.getElementById('start_Hours').value ="";
        document.getElementById('start_Min').value ="";
        document.getElementById('start_Sec').value ="";
        document.getElementById('end_Hours').value ="";
        document.getElementById('end_Min').value ="";
        document.getElementById('end_Sec').value ="";
        document.getElementById("files").disabled = false; 
        document.getElementById("button_times").disabled = true; 
        document.getElementById("type_poly").disabled = true; 
        document.getElementById("button_polyc").disabled = true; 
        document.getElementById("button_polyd").disabled = true; 
        document.getElementById("button_timediffs").disabled = true;

        function button_time_set() {
                get_timeparm();
                set_value();
                file_set_timeparm();
                list_set_timeparm();
        }

        function date2str(d){
            return d.getFullYear()+"/"+("0"+(d.getMonth() + 1)).slice(-2) + "/" + ("0"+d.getDate()).slice(-2)+" "+("0"+d.getHours()).slice(-2) + ":" + ("0"+d.getMinutes()).slice(-2) + ":" + ("0"+d.getSeconds()).slice(-2);
        }

        function time2str(d){
            return ("0"+d.getHours()).slice(-2) + ":" + ("0"+d.getMinutes()).slice(-2) + ":" + ("0"+d.getSeconds()).slice(-2);
        }

        function get_timeparm(){
            var get_startTime = new Date(startTime);
            var get_endTime = new Date(endTime);

            get_startTime.setHours(parseInt(document.getElementById('start_Hours').value, 10));
            get_startTime.setMinutes(parseInt(document.getElementById('start_Min').value, 10));
            get_startTime.setSeconds(parseInt(document.getElementById('start_Sec').value, 10));
            if((startTime < get_startTime) && (get_startTime < endTime)) startTime = get_startTime;

            get_endTime.setHours(parseInt(document.getElementById('end_Hours').value, 10));
            get_endTime.setMinutes(parseInt(document.getElementById('end_Min').value, 10));
            get_endTime.setSeconds(parseInt(document.getElementById('end_Sec').value, 10));
            if((endTime > get_endTime) && (get_endTime > startTime) ) endTime = get_endTime;

            get_timeparm_intper();
        }

        function get_timeparm_intper(){
            if(document.getElementById('time_interval').value == ""){
                intervalTime = 60;
            }else{
                intervalTime = parseInt(document.getElementById('time_interval').value, 10);
            }
            if(document.getElementById('time_period').value == ""){
                periodTime = 60;
            }else{
                periodTime = parseInt(document.getElementById('time_period').value, 10);
            }

            all_time = (endTime.getTime() - startTime.getTime())/1000;
            time_intvl_length = Math.ceil(all_time/intervalTime);
        }
        
        function list_set_timeparm(){
            document.getElementById("list").innerHTML  = 'Set parameters:: Time:' + date2str(startTime)
                                                    + ' - '+ time2str(endTime) + ", All:" 
                                                    + all_time + '(sec),/ Interval:' 
                                                    + intervalTime + '(sec),/ Period:'+  periodTime + '(sec)';
        }
        function file_set_timeparm(){
            document.getElementById('start_Hours').value = ("0"+startTime.getHours()).slice(-2);
            document.getElementById('start_Min').value = ("0"+startTime.getMinutes()).slice(-2);
            document.getElementById('start_Sec').value =  ("0"+startTime.getSeconds()).slice(-2);
            document.getElementById('end_Hours').value =  ("0"+endTime.getHours()).slice(-2);
            document.getElementById('end_Min').value = ("0"+endTime.getMinutes()).slice(-2);
            document.getElementById('end_Sec').value = ("0"+endTime.getSeconds()).slice(-2);
            document.getElementById('time_interval').value = intervalTime;
            document.getElementById('time_period').value = periodTime;
        }

//marker
        function convertCoordinate(longitude, latitude) {
          return ol.proj.transform([longitude, latitude], "EPSG:4326","EPSG:900913");
        }

        function makeMarkerOverlay(imgSrc, coordinate) {
            var imgElement = document.createElement('img');
            imgElement.setAttribute('src', imgSrc);
            var markerOverlay = new ol.Overlay({
                element: imgElement,
                position: coordinate,
                positioning: 'bottom-center'
            });
            return markerOverlay;
        }

        function button_mak_set() {
            Lon_maker = parseFloat(document.getElementById('mak_up').value, 10);
            Lat_maker = parseFloat(document.getElementById('mak_lo').value, 10);
            Ang_maker = parseFloat(document.getElementById('mak_or').value, 10);
            hubeny(Lat_maker);
            onMaker = 1;
            markerA = makeMarkerOverlay('http://dev.openlayers.org/img/marker.png',convertCoordinate(Lon_maker ,Lat_maker));
            map.addOverlay(markerA);	
        }

        function button_mak_del() {

            onMaker = 0;
            Lon_maker = -1;
            Lat_maker = -1;
            Ang_maker = -1;

            document.getElementById('mak_up').value = '';
            document.getElementById('mak_lo').value = '';
            document.getElementById('mak_or').value = '';
            map.getOverlays().getArray().slice(0).forEach(function(overlay) {
                map.removeOverlay(overlay);
            });

            button_line_del();
        }

//��p
        function hubeny(str2) {
            var dLamda = Math.PI / 180;
            var Rx = 6378137;                                                       //�ԓ����a�i���j
            var E2 = 0.00669437999019758000;                                        //���S���i���O�Q�j
            var inLatitude = str2;

            //�q�ߐ�E�K�ѐ�ȗ����a�̕���
            var W = Math.sqrt(1 - E2 *  Math.pow(Math.sin(inLatitude * Math.PI / 180), 2));    
            var M = dLamda * (Rx * (1 - E2)) / (W * W * W);                         //�q�ߐ�ȗ����a
            var N = (Rx * Math.cos(inLatitude * Math.PI / 180) * dLamda) / W;                 //�K�ѐ�ȗ����a

            Lat_m  = 1 / M;
            Lon_m = 1 / N;
        }

//��p
        function addLine_l() {
            var lineStrArray = new Array();
            var coordArray = new Array();
            var Lon_set_n;
            var Lat_set_n;
            var str3_ga = (Ang_maker + map_ang) % 360 + 180;
            var str3_i;

            if(isNaN(str3_input_up) )   str3_input_up = 18 ;
            if(isNaN(str3_input_lo) )   str3_input_lo = 22 ;
            if(isNaN(str3_input_deri) ) str3_input_deri = 2 ;
            if(isNaN(str3_input_dele) ) str3_input_dele = 35 ;

            map.removeLayer(lineVector_l);
            var str3_input_up_ga = str3_ga - str3_input_up;
            var str3_input_lo_ga = str3_ga + str3_input_lo;

            //3m
            str3_i = str3_input_lo_ga;
            while(str3_i > str3_input_up_ga){
                Lon_set_n = Lon_maker + ((str3_input_deri * Math.cos(str3_i * Math.PI / 180)) * Lon_m);;
                Lat_set_n = Lat_maker + ((str3_input_deri * Math.sin(str3_i * Math.PI / 180)) * Lat_m);;
                coordArray.push([Lon_set_n, Lat_set_n]);
                str3_i -= 10;
            }
            Lon_set_n = Lon_maker + ((str3_input_deri * Math.cos(str3_input_up_ga * Math.PI / 180)) * Lon_m);;
            Lat_set_n = Lat_maker + ((str3_input_deri * Math.sin(str3_input_up_ga * Math.PI / 180)) * Lat_m);;
            coordArray.push([Lon_set_n, Lat_set_n]);

            //30m
            str3_i = str3_input_up_ga;
            while(str3_i < str3_input_lo_ga){
                Lon_set_n = Lon_maker + ((str3_input_dele * Math.cos(str3_i * Math.PI / 180)) * Lon_m);;
                Lat_set_n = Lat_maker + ((str3_input_dele * Math.sin(str3_i * Math.PI / 180)) * Lat_m);;
                coordArray.push([Lon_set_n, Lat_set_n]);
                str3_i += 5;
            }
            Lon_set_n = Lon_maker + ((str3_input_dele * Math.cos(str3_input_lo_ga * Math.PI / 180)) * Lon_m);;
            Lat_set_n = Lat_maker + ((str3_input_dele * Math.sin(str3_input_lo_ga * Math.PI / 180)) * Lat_m);;
            coordArray.push([Lon_set_n, Lat_set_n]);

            Lon_set_n = Lon_maker + ((str3_input_deri * Math.cos(str3_input_lo_ga * Math.PI / 180)) * Lon_m);;
            Lat_set_n = Lat_maker + ((str3_input_deri * Math.sin(str3_input_lo_ga * Math.PI / 180)) * Lat_m);;
            coordArray.push([Lon_set_n, Lat_set_n]);


            for (i=0; i<(coordArray.length-1); i++) {
                lineStrArray.push([coordArray[i], coordArray[i+1]]);
            }

            var lineStrings = new ol.geom.MultiLineString([]);
            lineStrings.setCoordinates(lineStrArray);

            var vectorFeature = new ol.Feature(
                lineStrings.transform('EPSG:4326', 'EPSG:3857')
            );

            var vectorSource  = new ol.source.Vector({
                features: [vectorFeature]
            });
        // ���S�ݒ�p�� vector layer �̍쐬
            lineVector_l = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({ color: '#FF00FF', width: 2 }),//#FF00FF
                })
            });
            // vector layer �̒ǉ�
            map.addLayer(lineVector_l);
        }
        
        function button_line_set() {
            if(onMaker == 1){
                str3_input_up = parseFloat(document.getElementById('ang_up').value, 10);
                str3_input_lo = parseFloat(document.getElementById('ang_lo').value, 10);
                str3_input_deri = parseFloat(document.getElementById('de_ri').value, 10);
                str3_input_dele = parseFloat(document.getElementById('de_le').value, 10);
                addLine_l();
            }
        }
        
        function button_line_del() {
            map.removeLayer(lineVector_l);
            document.getElementById('ang_up').value  = '';
            document.getElementById('ang_lo').value  = '';
            document.getElementById('de_ri').value  = '';
            document.getElementById('de_le').value  = '';
        }

//////// polygon
        document.getElementsByName("None")[0].selected = true;

        var source_poly1 = new ol.source.Vector({wrapX: false});
        var source_poly2 = new ol.source.Vector({wrapX: false});

        var vector_poly1 = new ol.layer.Vector({
            source: source_poly1,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                color: 'rgba(255, 204, 204, 0.4)'
                }),
              stroke: new ol.style.Stroke({
                color: '#FF3333',
                width: 3
                })
            })
        });
        var vector_poly2 = new ol.layer.Vector({
            source: source_poly2,
            style: new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(127, 255, 212, 0.3)'
            }),
            stroke: new ol.style.Stroke({
                color: '#006400',
                width: 3
                })
            })
        });        
        
        var maxPoints = 10;
        var draw1 = new ol.interaction.Draw({
            source: source_poly1,
            type: ('Polygon'),
            maxPoints: maxPoints
        });
        var draw2 = new ol.interaction.Draw({
            source: source_poly2,
            type: ('Polygon'),
            maxPoints: maxPoints
        });

        var typeSelect = document.getElementById('type_poly');

        function addInteraction() {
            var value = typeSelect.value;
            map.removeInteraction(draw1);
            map.removeInteraction(draw2);

        if (value == 'Polygon1') {
            map.removeLayer(vector_poly1);
            map.addLayer(vector_poly1);
            map.addInteraction(draw1);
        }
        else if (value == 'Polygon2') {
            map.removeLayer(vector_poly2);
            map.addLayer(vector_poly2);
            map.addInteraction(draw2);
            }
        }  

        var polyStrArray_x = new Array();
        var polyStrArray_y = new Array();
        var poly_Array_on = [0,0];
        var poly_point_num = [0,0];        

        draw1.on('drawstart', function( evt ) {
            source_poly1.clear();
            poly_Array_on[0] = 0;
            document.getElementById("msg_poly_lot").innerHTML =  'drawstart....' ;
            document.getElementById("msg_poly_area").innerHTML =  '' ;
        });
        draw2.on('drawstart', function( evt ) {
            source_poly2.clear();
            poly_Array_on[1] = 0;
            document.getElementById("msg_poly_lot").innerHTML =  'drawstart....' ;
            document.getElementById("msg_poly_area").innerHTML =  '' ;
        });

        draw1.on('drawend', function( evt ) {
            var feature = evt.feature;
            var coords = feature.getGeometry().getCoordinates();
            var coordArray = coords.toString().split(",");

            polyStrArray_x[0] = new Array();
            polyStrArray_y[0] = new Array();
            poly_point_num[0] = coordArray.length/2;

            if((poly_point_num[0] > 0) && (onMaker == 1)){
                if(poly_Array_on[1] == 1){
                    document.getElementById("msg_poly_lot").innerHTML =  ' (Polygon1, Polygon2) ';
                }else{
                    document.getElementById("msg_poly_lot").innerHTML =  ' (Polygon1) ' ;
                }
                for (var i=0; i<poly_point_num[0]; i++) {    // ���p�`�̌o�ܓx�̎擾
                    var info = ol.proj.transform([coordArray[i*2], coordArray[(i*2)+1]], 'EPSG:3857', 'EPSG:4326');
                    polyStrArray_x[0][i] = info[0];
                    polyStrArray_y[0][i] = info[1];
                }

            var table = document.getElementById("table_poly");
            while( table.rows[ 0 ] ) table.deleteRow( 0 ); //�폜
                poly_Array_on[0] = 1;
            }
        });
        
        draw2.on('drawend', function( evt ) {

            var feature = evt.feature;
            var coords = feature.getGeometry().getCoordinates();
            var coordArray = coords.toString().split(",");

            polyStrArray_x[1] = new Array();
            polyStrArray_y[1] = new Array();
            poly_point_num[1] = coordArray.length/2;

            if((poly_point_num[1] > 0) && (onMaker == 1)){
                if(poly_Array_on[0] == 1){
                    document.getElementById("msg_poly_lot").innerHTML =  ' (Polygon1, Polygon2) ';
                }else{
                    document.getElementById("msg_poly_lot").innerHTML =  ' (Polygon2) ' ;
                }
                for (var i=0; i<poly_point_num[1]; i++) {    // ���p�`�̌o�ܓx�̎擾
                    var info = ol.proj.transform([coordArray[i*2], coordArray[(i*2)+1]], 'EPSG:3857', 'EPSG:4326');
                    polyStrArray_x[1][i] = info[0];
                    polyStrArray_y[1][i] = info[1];
                }

                var table = document.getElementById("table_poly");
                while( table.rows[ 0 ] ) table.deleteRow( 0 ); //�폜
                    poly_Array_on[1] = 1;
            }
        });

        typeSelect.onchange = function() {
           addInteraction();
        };

        function trimSpaces(str){   
            return str.replace(/^(\s|\u00A0)+/,'').replace(/(\s|\u00A0)+$/,'');   
        }        
        
        function button_poly_del() {
            source_poly1.clear();
            map.removeInteraction(draw1);
            map.removeLayer(vector_poly1);
            source_poly2.clear();
            map.removeInteraction(draw2);
            map.removeLayer(vector_poly2);
            poly_Array_on = [0,0];

            document.getElementById("msg_poly_lot").innerHTML =  '' ;
            document.getElementById("msg_poly_area").innerHTML =  '' ;
            var table = document.getElementById("table_poly");
            while( table.rows[ 0 ] ) table.deleteRow( 0 ); //�폜
            document.getElementsByName("None")[0].selected = true;
        }        
        
      function button_poly_calc() {
        var i;
        var result_area = [0, 0];
        //                var rate_area;
        // �ʐ�]

        document.getElementById("button_times").disabled = true; 
        document.getElementById("files").disabled = true; 
        document.getElementById("type_poly").disabled = true; 
        document.getElementById("button_polyc").disabled = true; 
        document.getElementById("button_polyd").disabled = true; 
        document.getElementById("button_timediffs").disabled = true; 

        if(poly_Array_on[0]==1){
            hubeny(polyStrArray_y[0][0]);
        }else if(poly_Array_on[1]==1){
            hubeny(polyStrArray_y[1][0]);
        }

       document.getElementById("msg_poly_area").innerHTML  = '<br>'; 

        for(i=0;i<2;i++){
            if(poly_Array_on[i]==1){
                result_area[i] = poly_area_calc(i);
                if(i==0){
                    document.getElementById("msg_poly_area").innerHTML  += '[Red Area: ' 
                                                    +  result_area[0].toFixed(2) + ' m' + '2'.sup() + ']';
                }else if(i==1){
                    document.getElementById("msg_poly_area").innerHTML  += '[Green Area: ' 
                                                    +  result_area[1].toFixed(2) + ' m' + '2'.sup() + ']';
                }
            }
        }

        var circle_area = ((str3_input_dele * str3_input_dele) - (str3_input_deri * str3_input_deri)) 
                                                         * Math.PI * ((str3_input_lo + str3_input_up)/360);
        document.getElementById("msg_poly_area").innerHTML  += '[Pink Area: ' 
                                + circle_area.toFixed(2) +  ' m' + '2'.sup() + ']';

        // ���ʌ��ʂ̃G���A���O����
        var periodTime_poly = parseInt(document.getElementById('time_period_poly').value, 10);
        var f_num = 0;
        var inc_count = 0;
        var judge_count = [0,0];
        var f_count_all = [];
        var f_count_select  = new Array();
        var f_count_end = [];

        var poly_end = new Date(startTime);
        poly_end.setSeconds(poly_end.getSeconds() + periodTime_poly);

        var coords;
        var coordArray;
        var judge_point;
        var samplingTime_poly;

        f_count_select[0]  = new Array();
        f_count_select[1]  = new Array();

        for(i=0;i<=file_length;i++){
            if((tm[i]>=startTime)&(tm[i]<endTime)){

                if(tm[i]>poly_end){
                   f_count_all[f_num] = inc_count;
                   f_count_select[0][f_num] = judge_count[0];
                   f_count_select[1][f_num] = judge_count[1];
                   f_count_end[f_num] = new Date(poly_end);
                   inc_count = 0;
                   judge_count = [0,0];
                   f_num += 1;
                   poly_end.setSeconds(poly_end.getSeconds() + periodTime_poly);
                }
                inc_count += 1;
                coords = pointFeatures[i].getGeometry().getCoordinates();
                coordArray = coords.toString().split(",");
                judge_point = ol.proj.transform([coordArray[0], coordArray[1]], 'EPSG:3857', 'EPSG:4326');

                judge_count[0] += judge(judge_point[0], judge_point[1], 0);
                judge_count[1] += judge(judge_point[0], judge_point[1], 1);
            }
        }
        f_count_all[f_num] = inc_count;
        f_count_select[0][f_num] = judge_count[0];
        f_count_select[1][f_num] = judge_count[1];
        if(endTime < poly_end) poly_end = endTime;
        f_count_end[f_num] = new Date(poly_end);
        f_num += 1;

        // 1�t���[���Ԋu
        if(samplingTime == 0){
            samplingTime_poly = ((tm[file_length].getTime() - tm[0].getTime())/1000)/(frameNo[file_length]-frameNo[0]+1);
        }else{
            samplingTime_poly = samplingTime;
        }
        samplingTime_poly = 1/samplingTime_poly;
        document.getElementById("msg_poly_area").innerHTML  += '<br>' + samplingTime_poly.toFixed(2) + 'fps'; 

        // �\�̍쐬
        var table = document.getElementById("table_poly");
        while( table.rows[ 0 ] ) table.deleteRow( 0 ); //�폜
        var label_row = table.insertRow( -1 );
        var label_cell_1;
        var rate_people;
        var column_num = 5;
        if((poly_Array_on[0]==1)&&(poly_Array_on[1]==1)) column_num = 7;

        for(i=0;i<3;i++){
            label_cell_1 = label_row.insertCell( -1 );
            table.rows[ 0 ].cells[ i ].style.backgroundColor  = '#eee';
            table.rows[ 0 ].cells[ i ].style.fontWeight = "bold";;
        }
        table.rows[ 0 ].cells[ 0 ].innerText  = "Time";
        table.rows[ 0 ].cells[ 0 ].colSpan = 2;
        if(column_num == 5){
            table.rows[ 0 ].cells[ 1 ].colSpan = 2;
        }else{ //Population density: 782.1898 persons/km2
            table.rows[ 0 ].cells[ 1 ].colSpan = 3;
            table.rows[ 0 ].cells[ 2 ].colSpan = 2;
        }
        table.rows[ 0 ].cells[ 1 ].innerText  = "Average";
        table.rows[ 0 ].cells[ 2 ].innerText  = "Density (@100m2)";
        label_row = table.insertRow( -1 );

        for(i=0;i<column_num;i++){
            label_cell_1 = label_row.insertCell( -1 );
            table.rows[ 1 ].cells[ i ].style.backgroundColor  = '#eee';
            table.rows[ 1 ].cells[ i ].style.fontWeight = "bold";;
            table.rows[ 1 ].cells[ i ].style.width = "900px";;
        }
        table.rows[ 1 ].cells[ 0 ].innerText  = "Start Time";
        table.rows[ 1 ].cells[ 1 ].innerText  = "End Time";
        var table_title = ["Red Area", "Green Area", "Pink Area"];
        var table_rate = ["Red Area", "Green Area"];
        var column_pos = 2;
        column_pos = 2;
        var column_redrate_pos = 2 + poly_Array_on[1];
        var column_greenrate_pos = 2 + poly_Array_on[0];
        if(poly_Array_on[0]==1){
            table.rows[ 1 ].cells[ column_pos ].innerText  = table_title[0];
            table.rows[ 1 ].cells[ column_pos + column_redrate_pos ].innerText  = table_rate[0];
            column_pos++
        }
        if(poly_Array_on[1]==1){
            table.rows[ 1 ].cells[ column_pos ].innerText  = table_title[1];
            table.rows[ 1 ].cells[ column_pos + column_greenrate_pos ].innerText  = table_rate[1];
            column_pos++
        }
        table.rows[ 1 ].cells[ column_pos ].innerText  = table_title[2];

        for(i=0;i<f_num;i++){
            label_row = table.insertRow( -1 );
            for(var j=0;j<column_num;j++){
                label_cell_1 = label_row.insertCell( -1 );
            }
            if(i==0){
                table.rows[ i+2 ].cells[ 0 ].innerText  = time2str(startTime);
            }else{
                table.rows[ i+2 ].cells[ 0 ].innerText  = time2str(f_count_end[i-1]);
            }
            table.rows[ i+2 ].cells[ 1 ].innerText  = time2str(f_count_end[i]);
            column_pos = 2;
            if(poly_Array_on[0]==1){
                rate_people =  (f_count_select[0][i]/(samplingTime_poly*periodTime_poly));
                table.rows[ i+2 ].cells[ column_pos ].innerText  
                               = rate_people.toFixed(2);
                rate_people =  rate_people / (result_area[0]/100);
                table.rows[ i+2 ].cells[ column_pos + column_redrate_pos ].innerText  = rate_people.toFixed(2);
                column_pos++;
            }
            if(poly_Array_on[1]==1){
                rate_people =  (f_count_select[1][i]/(samplingTime_poly*periodTime_poly));
                table.rows[ i+2 ].cells[ column_pos ].innerText  
                               = rate_people.toFixed(2);
                rate_people =  rate_people /  (result_area[1]/100);
                table.rows[ i+2 ].cells[ column_pos + column_greenrate_pos ].innerText  = rate_people.toFixed(2);
                column_pos++;
            }
            table.rows[ i+2 ].cells[ column_pos ].innerText = (f_count_all[i]/(samplingTime_poly*periodTime_poly)).toFixed(2);
        }

        document.getElementById("button_times").disabled = false; 
        document.getElementById("files").disabled = false; 
        document.getElementById("type_poly").disabled = false; 
        document.getElementById("button_polyc").disabled = false; 
        document.getElementById("button_polyd").disabled = false; 
        document.getElementById("button_timediffs").disabled = false; 
    }        
 
//���p�`�̖ʐ�
    function poly_area_calc(poly_num) {
        var area_x = 0;
        var area_y = 0;
        var zeropoint_y = polyStrArray_y[poly_num][0] * 2;
        var poly_area = 0;
        for (i=0; i<(poly_point_num[poly_num]-1); i++) {
            area_x = (polyStrArray_x[poly_num][i] - polyStrArray_x[poly_num][i+1]);
            area_y = (polyStrArray_y[poly_num][i] + polyStrArray_y[poly_num][i+1] - zeropoint_y);
            poly_area += area_x * area_y;
        }
        poly_area = Math.abs(poly_area / Lon_m / Lat_m / 2);
        return poly_area;
    }
 
//���p�`�̓��O����
    function judge(judge_point_x, judge_point_y, color_num) {
        var judge_result = 0;
        var all_angle = 0;
        for (var i=0; i<(poly_point_num[color_num]-1); i++) {
            all_angle += func_tan(judge_point_x, judge_point_y, i, color_num);
        }
        all_angle = Math.abs(all_angle);
        if(all_angle > 3 ){ // 2*PI �Ő}�`���ɓ_�����݁B�]�T��������PI�ȏ�Ȃ�B
            judge_result = 1;
        }
        return judge_result;
    } 

    function func_tan(judge_point_x, judge_point_y, i_num, color_num) {
        var angle = 0;
        var Ax, Ay, Bx, By;
        var AB_cos, AB_sin;

        Ax = polyStrArray_x[color_num][i_num] - judge_point_x;
        Ay = polyStrArray_y[color_num][i_num] - judge_point_y;
        Bx = polyStrArray_x[color_num][i_num+1] - judge_point_x;
        By = polyStrArray_y[color_num][i_num+1] - judge_point_y;

        AB_cos = Ax * Bx + Ay * By;
        AB_sin = Ax * By - Ay * Bx;

        angle = Math.atan2(AB_sin, AB_cos);

        return angle;
    }    
    
    //����
    function button_timediff_set() {
        document.getElementById("button_times").disabled = true; 
        document.getElementById("files").disabled = true; 
        document.getElementById("type_poly").disabled = true; 
        document.getElementById("button_polyc").disabled = true; 
        document.getElementById("button_polyd").disabled = true; 
        document.getElementById("button_timediffs").disabled = true; 

        // ��������
        var time_diff_d = time_diff;
        time_diff = parseFloat(document.getElementById('tm_df').value, 10);
        if(isNaN(time_diff) )   time_diff = -8 ;

        time_diff_d = time_diff - time_diff_d;

        if(time_diff_d != 0){
            for(i=0;i<=file_length;i++){
                tm[i].setHours(tm[i].getHours() + time_diff_d);
            }
            startTime.setHours(startTime.getHours() + time_diff_d);
            endTime.setHours(endTime.getHours() + time_diff_d);
        }

        get_timeparm_intper();

        set_value();
        file_set_timeparm();
        list_set_timeparm();

        document.getElementById("button_times").disabled = false; 
        document.getElementById("files").disabled = false; 
        document.getElementById("type_poly").disabled = false; 
        document.getElementById("button_polyc").disabled = false; 
        document.getElementById("button_polyd").disabled = false; 
        document.getElementById("button_timediffs").disabled = false; 
    }    
    
    
    </script>
</body>
</html>